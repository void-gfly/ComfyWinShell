# 扩展模型目录功能说明

## 功能概述

在配置页面的"路径设置"中新增了**扩展模型目录**功能，允许用户指定一个额外的模型存储位置，实现模型文件的跨实例共享。

## 使用方法

### 1. 设置扩展模型目录

在配置页面 → 路径设置 → 找到"扩展模型目录 (Extra Models Base)"：

```
扩展模型目录 (Extra Models Base)
[__________________________] [浏览]
💡 该目录下应包含 models/checkpoints、models/loras 等标准子目录
```

### 2. 目录结构要求

指定的目录应遵循标准的 ComfyUI 模型目录结构：

```
你的扩展模型目录/
├── models/
│   ├── checkpoints/      # Stable Diffusion 主模型
│   ├── loras/            # LoRA 模型
│   ├── vae/              # VAE 模型
│   ├── controlnet/       # ControlNet 模型
│   ├── clip/             # CLIP 模型
│   ├── clip_vision/      # CLIP Vision 模型
│   ├── configs/          # 配置文件
│   ├── diffusion_models/ # Diffusion 模型
│   ├── embeddings/       # Embeddings
│   └── upscale_models/   # 超分辨率模型
```

### 3. 保存配置

点击"保存配置"按钮后，系统会自动：
1. 验证目录是否存在
2. 在 ComfyUI 根目录下生成 `extra_model_paths.yaml` 文件
3. 保存配置到当前 Profile

生成的 `extra_model_paths.yaml` 内容示例：

```yaml
# Auto-generated by ComfyShell
# 扩展模型路径配置

comfyui_extra:
    base_path: E:/AI_Models/
    checkpoints: models/checkpoints/
    clip: models/clip/
    clip_vision: models/clip_vision/
    configs: models/configs/
    controlnet: models/controlnet/
    diffusion_models: models/diffusion_models/
    embeddings: models/embeddings/
    loras: models/loras/
    upscale_models: models/upscale_models/
    vae: models/vae/
```

### 4. 重启 ComfyUI

配置保存后，**需要重启 ComfyUI** 才能使扩展模型路径生效。

重启后，ComfyUI 会同时加载：
- 基础目录下的 `models/`
- 扩展目录下的 `models/`

## 应用场景

### 场景 1：与 Stable Diffusion WebUI 共享模型

```
WebUI 安装目录/
├── models/
│   ├── Stable-diffusion/  # checkpoints
│   ├── Lora/              # loras
│   └── VAE/               # vae
```

在 ComfyShell 中设置"扩展模型目录"为 WebUI 的安装目录，即可共享模型。

### 场景 2：多个 ComfyUI 实例共享模型库

```
E:\AI_Shared_Models/
├── models/
│   ├── checkpoints/
│   ├── loras/
│   └── vae/
```

多个 ComfyUI 实例都设置相同的扩展模型目录，节省磁盘空间。

### 场景 3：分盘存储

- C 盘：ComfyUI 程序（基础目录）+ 常用小模型
- E 盘：大容量存储（扩展目录）+ 大型模型文件

## 取消扩展目录

如需取消扩展模型目录：
1. 清空"扩展模型目录"输入框
2. 点击"保存配置"
3. 系统会自动删除 `extra_model_paths.yaml` 文件

## 技术细节

### 实现位置

- **数据模型**：`Models/ComfyConfiguration.cs` → `PathConfiguration.ExtraModelBaseDirectory`
- **业务逻辑**：`ViewModels/ConfigurationViewModel.cs` → `GenerateExtraModelPathsYamlAsync()`
- **UI 界面**：`Views/ConfigurationView.xaml` → "路径设置" Expander

### 生成逻辑

1. 验证扩展目录存在性
2. 验证 ComfyUI 安装路径有效性
3. 规范化路径（统一使用正斜杠 `/`）
4. 生成标准 YAML 配置
5. 写入 `ComfyUI/extra_model_paths.yaml`

### 错误处理

- 目录不存在 → 弹窗提示错误
- ComfyUI 路径无效 → 弹窗提示错误
- 文件写入失败 → 弹窗显示异常信息

## 注意事项

⚠️ **路径规范**
- 支持中文路径
- 支持网络路径（UNC 路径）
- 路径会自动规范化为正斜杠

⚠️ **重启要求**
- 修改扩展目录后必须重启 ComfyUI
- YAML 配置不会热重载

⚠️ **目录冲突**
- 如果基础目录和扩展目录有同名模型，ComfyUI 会加载两个
- 在加载器节点中会显示重复的模型名称

⚠️ **高级配置**
- "额外配置文件路径 (Advanced)" 输入框保持不变
- 用于手动指定自定义的 YAML 配置文件路径
- 适合需要更复杂配置的高级用户

## 常见问题

**Q: 设置扩展目录后，为什么模型列表没有变化？**
A: 需要重启 ComfyUI。ComfyUI 仅在启动时读取 `extra_model_paths.yaml`。

**Q: 可以设置多个扩展目录吗？**
A: 当前版本仅支持一个扩展目录。如需更复杂的配置，请使用"额外配置文件路径"手动编辑 YAML。

**Q: 扩展目录下没有某个模型类型的文件夹怎么办？**
A: 不影响使用。ComfyUI 会跳过不存在的路径。

**Q: 与资源管理页面的关系？**
A: 当前资源管理页面仅扫描基础目录。未来版本将整合扩展目录的模型统计。

---

**版本**：v1.0  
**更新日期**：2026-01-14
